{% extends "base.html" %}

{% block title %}Scraping de Música - Panel L3HO{% endblock %}

{% block extra_css %}
<style>
    .scraping-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
    }
    
    .source-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-left: 5px solid;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .source-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }
    
    .source-card.youtube { border-left-color: #ff0000; }
    .source-card.soundcloud { border-left-color: #ff8c00; }
    .source-card.jamendo { border-left-color: #02b875; }
    .source-card.audiomack { border-left-color: #ff6600; }
    .source-card.musixmatch { border-left-color: #1db954; }
    .source-card.bandcamp { border-left-color: #629aa0; }
    .source-card.vagalume { border-left-color: #e91e63; }
    
    .status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-weight: 600;
    }
    
    .status-active {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-inactive {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .method-tag {
        display: inline-block;
        background: #e9ecef;
        color: #495057;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        margin: 0.1rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin: 2rem 0;
    }
    
    .stat-card {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #667eea, #764ba2);
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #667eea;
        display: block;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    
    .test-result {
        margin-top: 0.75rem;
        padding: 0.75rem;
        border-radius: 8px;
        font-size: 0.85rem;
    }
    
    .test-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .test-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .test-loading {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .btn-scraping {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
        color: white;
        transition: all 0.3s ease;
    }
    
    .btn-scraping:hover {
        background: linear-gradient(135deg, #764ba2, #667eea);
        color: white;
        transform: translateY(-1px);
    }
    
    .demo-section {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 2rem;
        margin: 2rem 0;
    }
    
    .priority-indicator {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        background: #667eea;
        color: white;
        border-radius: 50%;
        font-size: 0.75rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header del Panel de Scraping -->
<div class="scraping-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1><i class="fas fa-search me-3"></i>Panel de Scraping de Música</h1>
                <p class="mb-0">Sistema profesional de extracción de datos reales sin dependencia de APIs comerciales</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="{{ url_for('music_panel') }}" class="btn btn-outline-light me-2">
                    <i class="fas fa-music"></i> Panel Principal
                </a>
                <a href="{{ url_for('master_panel') }}" class="btn btn-outline-light">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- Estadísticas Generales -->
    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-number">{{ sources_status.data.total_sources if sources_status.success else 0 }}</span>
            <div class="stat-label">Fuentes Disponibles</div>
        </div>
        <div class="stat-card">
            <span class="stat-number">{{ sources_status.data.active_sources if sources_status.success else 0 }}</span>
            <div class="stat-label">Fuentes Activas</div>
        </div>
        <div class="stat-card">
            <span class="stat-number">{{ cache_stats.data.total_files if cache_stats.success else 0 }}</span>
            <div class="stat-label">Archivos Descargados</div>
        </div>
        <div class="stat-card">
            <span class="stat-number">{{ "%.1f"|format(cache_stats.data.total_size_mb if cache_stats.success else 0) }} MB</span>
            <div class="stat-label">Almacenamiento Usado</div>
        </div>
    </div>
    
    <div class="row">
        <!-- Fuentes de Scraping -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-database"></i> Fuentes de Scraping Activas</h5>
                    <small class="text-muted">Sistema automático sin necesidad de API keys externas</small>
                </div>
                <div class="card-body">
                    {% if sources_status.success and sources_status.data.sources %}
                    {% for source_key, source_info in sources_status.data.sources.items() %}
                    <div class="source-card {{ source_key }}">
                        <div class="row align-items-center">
                            <div class="col-md-1">
                                <div class="priority-indicator">{{ source_info.priority }}</div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="mb-1">
                                    {% if source_key == 'youtube_music' %}
                                        <i class="fab fa-youtube"></i> YouTube Music
                                    {% elif source_key == 'soundcloud' %}
                                        <i class="fab fa-soundcloud"></i> SoundCloud
                                    {% elif source_key == 'jamendo' %}
                                        <i class="fas fa-music"></i> Jamendo
                                    {% elif source_key == 'audiomack' %}
                                        <i class="fas fa-headphones"></i> Audiomack
                                    {% elif source_key == 'musixmatch' %}
                                        <i class="fas fa-file-alt"></i> Musixmatch
                                    {% elif source_key == 'bandcamp' %}
                                        <i class="fas fa-compact-disc"></i> Bandcamp
                                    {% elif source_key == 'vagalume' %}
                                        <i class="fas fa-quote-right"></i> Vagalume
                                    {% else %}
                                        <i class="fas fa-globe"></i> {{ source_info.name }}
                                    {% endif %}
                                </h6>
                                <small class="text-muted">{{ source_info.name }}</small>
                                
                                <div class="mt-2">
                                    {% for method in source_info.methods %}
                                    <span class="method-tag">{{ method }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <span class="status-badge {{ 'status-active' if source_info.active else 'status-inactive' }}">
                                    {{ 'Activa' if source_info.active else 'Inactiva' }}
                                </span>
                            </div>
                            <div class="col-md-2 text-end">
                                {% if session.is_admin %}
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-scraping" 
                                            onclick="testScrapingSource('{{ source_key }}')">
                                        <i class="fas fa-vial"></i> Probar
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Resultado de prueba -->
                        <div id="test-result-{{ source_key }}" class="test-result" style="display: none;"></div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle"></i> Error cargando fuentes</h6>
                        <p>No se pudieron cargar las fuentes de scraping. Verifica la configuración del sistema.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Panel de Control -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-cogs"></i> Control del Sistema</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="/music/scraping/demo" class="btn btn-scraping">
                            <i class="fas fa-play"></i> Demostración en Vivo
                        </a>
                        
                        {% if session.is_admin %}
                        <button class="btn btn-outline-primary" onclick="refreshAllSources()">
                            <i class="fas fa-sync"></i> Actualizar Fuentes
                        </button>
                        
                        <button class="btn btn-outline-warning" onclick="clearScrapingCache()">
                            <i class="fas fa-trash"></i> Limpiar Caché
                        </button>
                        
                        <button class="btn btn-outline-info" onclick="exportScrapingConfig()">
                            <i class="fas fa-download"></i> Exportar Config
                        </button>
                        {% endif %}
                        
                        <hr>
                        
                        <a href="/api/music/info?key={{ current_user.api_key if current_user else 'TU_API_KEY' }}" 
                           target="_blank" class="btn btn-outline-secondary">
                            <i class="fas fa-book"></i> Documentación API
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Información del Sistema -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> Información</h5>
                </div>
                <div class="card-body">
                    <h6>Ventajas del Scraping:</h6>
                    <ul class="small">
                        <li>Sin límites de API</li>
                        <li>Acceso a fuentes gratuitas</li>
                        <li>Datos en tiempo real</li>
                        <li>Sin dependencia comercial</li>
                        <li>Fallback automático</li>
                    </ul>
                    
                    <h6>Fuentes Principales:</h6>
                    <div class="small">
                        <div><strong>YouTube Music:</strong> Búsquedas y descargas</div>
                        <div><strong>SoundCloud:</strong> Catálogo independiente</div>
                        <div><strong>Jamendo:</strong> Música libre y legal</div>
                        <div><strong>Audiomack:</strong> Artistas emergentes</div>
                        <div><strong>Bandcamp:</strong> Música independiente</div>
                        <div><strong>Musixmatch:</strong> Letras de canciones</div>
                        <div><strong>Vagalume:</strong> Letras alternativas</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Demostración Rápida -->
    <div class="demo-section">
        <h5><i class="fas fa-rocket"></i> Demostración Rápida del Scraping</h5>
        <p class="text-muted">Prueba el sistema de scraping con búsquedas de ejemplo</p>
        
        <div class="row">
            <div class="col-md-3">
                <button class="btn btn-scraping w-100" onclick="demoSearch('songs', 'love')">
                    <i class="fas fa-music"></i><br>
                    <small>Buscar "love"</small>
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-scraping w-100" onclick="demoSearch('albums', 'greatest hits')">
                    <i class="fas fa-compact-disc"></i><br>
                    <small>Álbum "greatest hits"</small>
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-scraping w-100" onclick="demoSearch('charts', 'global')">
                    <i class="fas fa-chart-line"></i><br>
                    <small>Charts Global</small>
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-scraping w-100" onclick="demoSearch('lyrics', 'imagine')">
                    <i class="fas fa-file-alt"></i><br>
                    <small>Letras "Imagine"</small>
                </button>
            </div>
        </div>
        
        <!-- Resultado de demostración -->
        <div id="demo-result" class="mt-3" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h6>Resultado de la Demostración</h6>
                </div>
                <div class="card-body">
                    <pre id="demo-content" class="small"></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function testScrapingSource(sourceKey) {
    const resultDiv = document.getElementById(`test-result-${sourceKey}`);
    resultDiv.style.display = 'block';
    resultDiv.className = 'test-result test-loading';
    resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Probando fuente de scraping...';
    
    fetch(`/music/test-scraping/${sourceKey}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultDiv.className = 'test-result test-success';
                resultDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${data.message}${data.sample_results ? ` (${data.sample_results} resultados)` : ''}`;
            } else {
                resultDiv.className = 'test-result test-error';
                resultDiv.innerHTML = `<i class="fas fa-times-circle"></i> ${data.message}`;
            }
        })
        .catch(error => {
            resultDiv.className = 'test-result test-error';
            resultDiv.innerHTML = `<i class="fas fa-times-circle"></i> Error de conexión: ${error.message}`;
        });
}

function demoSearch(type, query) {
    const resultDiv = document.getElementById('demo-result');
    const contentDiv = document.getElementById('demo-content');
    
    resultDiv.style.display = 'block';
    contentDiv.innerHTML = 'Realizando búsqueda por scraping...';
    
    let endpoint = '';
    let params = `key={{ current_user.api_key if current_user else 'TU_API_KEY' }}`;
    
    switch(type) {
        case 'songs':
            endpoint = '/api/music/search/songs';
            params += `&q=${encodeURIComponent(query)}&limit=3`;
            break;
        case 'albums':
            endpoint = '/api/music/search/albums';
            params += `&q=${encodeURIComponent(query)}&limit=2`;
            break;
        case 'charts':
            endpoint = '/api/music/charts';
            params += '&limit=5';
            break;
        case 'lyrics':
            endpoint = '/api/music/lyrics';
            params += '&title=Imagine&artist=John Lennon';
            break;
    }
    
    fetch(`${endpoint}?${params}`)
        .then(response => response.json())
        .then(data => {
            contentDiv.innerHTML = JSON.stringify(data, null, 2);
        })
        .catch(error => {
            contentDiv.innerHTML = `Error: ${error.message}`;
        });
}

function refreshAllSources() {
    location.reload();
}

function clearScrapingCache() {
    if (confirm('¿Limpiar todo el caché de scraping? Esta acción no se puede deshacer.')) {
        fetch('/api/music/cache/clear?key={{ current_user.api_key if current_user else "" }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Caché limpiado correctamente');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

function exportScrapingConfig() {
    // Función para exportar configuración
    alert('Funcionalidad de exportación en desarrollo');
}

// Auto-actualizar cada 5 minutos
setInterval(refreshAllSources, 300000);
</script>
{% endblock %}