{% extends "base_new.html" %}

{% block title %}Liga MX{% endblock %}
{% block page_title %}Liga MX - Torneo Apertura 2024{% endblock %}
{% block page_description %}Datos en tiempo real de la Liga MX con información de múltiples fuentes{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header con acciones rápidas -->
    <div class="bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
            <div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-futbol mr-2 text-green-500"></i>Panel Liga MX
                </h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                    Última actualización: <span id="last-update">{{ last_update or 'Cargando...' }}</span>
                </p>
            </div>
            <div class="flex space-x-3">
                <button id="refresh-data" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>Actualizar Datos
                </button>
                <button id="export-data" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-download mr-2"></i>Exportar
                </button>
            </div>
        </div>
    </div>

    <!-- Estadísticas rápidas -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg card-hover">
            <div class="flex items-center">
                <div class="p-3 bg-green-100 dark:bg-green-900 rounded-lg">
                    <i class="fas fa-users text-green-600 dark:text-green-400 text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white">18</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Equipos</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg card-hover">
            <div class="flex items-center">
                <div class="p-3 bg-blue-100 dark:bg-blue-900 rounded-lg">
                    <i class="fas fa-calendar text-blue-600 dark:text-blue-400 text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="total-matches">--</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Partidos</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg card-hover">
            <div class="flex items-center">
                <div class="p-3 bg-yellow-100 dark:bg-yellow-900 rounded-lg">
                    <i class="fas fa-trophy text-yellow-600 dark:text-yellow-400 text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="goals-scored">--</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Goles</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg card-hover">
            <div class="flex items-center">
                <div class="p-3 bg-purple-100 dark:bg-purple-900 rounded-lg">
                    <i class="fas fa-newspaper text-purple-600 dark:text-purple-400 text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="news-count">--</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Noticias</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenido principal con pestañas -->
    <div class="bg-white dark:bg-gray-800 shadow-lg rounded-xl">
        <!-- Navegación de pestañas -->
        <div class="border-b border-gray-200 dark:border-gray-700">
            <nav class="flex space-x-4 sm:space-x-8 px-4 sm:px-6 overflow-x-auto">
                <button class="tab-button active py-4 px-2 sm:px-1 border-b-2 border-green-500 font-medium text-sm text-green-600 dark:text-green-400 whitespace-nowrap" data-tab="tabla">
                    <i class="fas fa-list mr-1 sm:mr-2"></i><span class="hidden sm:inline">Tabla de </span>Posiciones
                </button>
                <button class="tab-button py-4 px-2 sm:px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 whitespace-nowrap" data-tab="calendario">
                    <i class="fas fa-calendar-alt mr-1 sm:mr-2"></i>Calendario
                </button>
                <button class="tab-button py-4 px-2 sm:px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 whitespace-nowrap" data-tab="estadisticas">
                    <i class="fas fa-chart-bar mr-1 sm:mr-2"></i>Estadísticas
                </button>
                <button class="tab-button py-4 px-2 sm:px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 whitespace-nowrap" data-tab="noticias">
                    <i class="fas fa-newspaper mr-1 sm:mr-2"></i>Noticias
                </button>
            </nav>
        </div>

        <!-- Contenido de pestañas -->
        <div class="p-4 sm:p-6">
            <!-- Tabla de Posiciones -->
            <div id="tabla-content" class="tab-content">
                <!-- Versión móvil (tarjetas) -->
                <div class="lg:hidden space-y-4" id="tabla-mobile">
                    <!-- Se llenará dinámicamente -->
                </div>
                
                <!-- Versión desktop (tabla) -->
                <div class="hidden lg:block">
                    <div class="table-responsive">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-900">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Pos</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Equipo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">PJ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">G</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">E</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">P</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">GF</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">GC</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">DIF</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">PTS</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Se llenará dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Indicadores de clasificación -->
                <div class="mt-6 flex flex-wrap gap-4">
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>
                        <span class="text-sm text-gray-600 dark:text-gray-400">Clasificación directa</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-blue-500 rounded mr-2"></div>
                        <span class="text-sm text-gray-600 dark:text-gray-400">Repechaje</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-red-500 rounded mr-2"></div>
                        <span class="text-sm text-gray-600 dark:text-gray-400">Descenso</span>
                    </div>
                </div>
            </div>

            <!-- Calendario -->
            <div id="calendario-content" class="tab-content hidden">
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Próximos Partidos</h4>
                        <div class="flex space-x-2">
                            <button class="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg">Jornada Anterior</button>
                            <button class="px-3 py-1 text-sm bg-green-600 text-white rounded-lg">Jornada Actual</button>
                            <button class="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg">Jornada Siguiente</button>
                        </div>
                    </div>
                    <div id="calendario-matches" class="grid gap-4">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
            </div>

            <!-- Estadísticas -->
            <div id="estadisticas-content" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Goleadores -->
                    <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                            <i class="fas fa-futbol mr-2 text-green-500"></i>Tabla de Goleadores
                        </h4>
                        <div id="goleadores-list" class="space-y-3">
                            <!-- Se llenará dinámicamente -->
                        </div>
                    </div>

                    <!-- Equipos con más goles -->
                    <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                            <i class="fas fa-chart-bar mr-2 text-blue-500"></i>Equipos Goleadores
                        </h4>
                        <div class="h-64">
                            <canvas id="goalsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Noticias -->
            <div id="noticias-content" class="tab-content hidden">
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Últimas Noticias</h4>
                        <div class="text-sm text-gray-500 dark:text-gray-400">
                            Fuentes: ESPN, Mediotiempo, Futbol Total
                        </div>
                    </div>
                    <div id="noticias-list" class="space-y-4">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Variables globales
    let currentTab = 'tabla';
    let ligaMXData = {};
    
    // Gestión de pestañas
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            switchTab(tabName);
        });
    });
    
    function switchTab(tabName) {
        // Actualizar botones
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active', 'border-green-500', 'text-green-600');
            btn.classList.add('border-transparent', 'text-gray-500');
        });
        
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active', 'border-green-500', 'text-green-600');
        document.querySelector(`[data-tab="${tabName}"]`).classList.remove('border-transparent', 'text-gray-500');
        
        // Mostrar contenido
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        document.getElementById(`${tabName}-content`).classList.remove('hidden');
        
        currentTab = tabName;
    }
    
    // Cargar datos de Liga MX
    function loadLigaMXData() {
        const loadingOverlay = document.createElement('div');
        loadingOverlay.innerHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white dark:bg-gray-800 rounded-lg p-6 flex items-center space-x-3">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-500"></div>
                    <span class="text-gray-900 dark:text-white">Cargando datos de Liga MX...</span>
                </div>
            </div>
        `;
        document.body.appendChild(loadingOverlay);
        
        fetch('/api/liga-mx/data-completa')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    ligaMXData = data.data;
                    updateAllContent();
                    document.getElementById('last-update').textContent = 
                        new Date(ligaMXData.ultima_actualizacion).toLocaleString('es-MX');
                    
                    PanelL3HO.showNotification('Datos de Liga MX actualizados correctamente', 'success');
                } else {
                    PanelL3HO.showNotification('Error al cargar datos: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                PanelL3HO.showNotification('Error de conexión al cargar datos', 'error');
            })
            .finally(() => {
                loadingOverlay.remove();
            });
    }
    
    function updateAllContent() {
        updateTabla();
        updateEstadisticas();
        updateNoticias();
        updateStats();
    }
    
    function updateTabla() {
        const tbody = document.getElementById('tabla-body');
        const mobileContainer = document.getElementById('tabla-mobile');
        
        if (tbody) tbody.innerHTML = '';
        if (mobileContainer) mobileContainer.innerHTML = '';
        
        if (ligaMXData.tabla) {
            ligaMXData.tabla.forEach((equipo, index) => {
                // Determinar color de posición
                let positionClass = '';
                if (index < 4) positionClass = 'bg-green-100 text-green-800';
                else if (index < 12) positionClass = 'bg-blue-100 text-blue-800';
                else if (index >= 15) positionClass = 'bg-red-100 text-red-800';
                
                // Versión desktop (tabla)
                if (tbody) {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${positionClass}">
                                ${equipo.posicion}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="text-sm font-medium text-gray-900 dark:text-white">${equipo.equipo}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${equipo.partidos_jugados}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${equipo.ganados || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${equipo.empatados || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${equipo.perdidos || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${equipo.goles_favor || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${equipo.goles_contra || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${(equipo.goles_favor || 0) - (equipo.goles_contra || 0)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm font-semibold text-gray-900 dark:text-white">${equipo.puntos}</span>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
                
                // Versión móvil (tarjetas)
                if (mobileContainer) {
                    const card = document.createElement('div');
                    card.className = 'bg-white dark:bg-gray-800 rounded-lg p-4 shadow';
                    
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${positionClass}">
                                    ${equipo.posicion}
                                </span>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${equipo.equipo}</h3>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-gray-900 dark:text-white">${equipo.puntos}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">PTS</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div class="text-center">
                                <div class="font-semibold text-gray-900 dark:text-white">${equipo.partidos_jugados}</div>
                                <div class="text-gray-500 dark:text-gray-400">PJ</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-green-600">${equipo.ganados || 0}</div>
                                <div class="text-gray-500 dark:text-gray-400">G</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-red-600">${equipo.perdidos || 0}</div>
                                <div class="text-gray-500 dark:text-gray-400">P</div>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600 dark:text-gray-400">GF: ${equipo.goles_favor || 0}</span>
                                <span class="text-gray-600 dark:text-gray-400">GC: ${equipo.goles_contra || 0}</span>
                                <span class="font-semibold text-gray-900 dark:text-white">DIF: ${(equipo.goles_favor || 0) - (equipo.goles_contra || 0)}</span>
                            </div>
                        </div>
                    `;
                    mobileContainer.appendChild(card);
                }
            });
        }
    }
    
    function updateEstadisticas() {
        if (ligaMXData.estadisticas && ligaMXData.estadisticas.goleadores) {
            const goleadoresList = document.getElementById('goleadores-list');
            goleadoresList.innerHTML = '';
            
            ligaMXData.estadisticas.goleadores.slice(0, 10).forEach((goleador, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded-lg';
                item.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="w-8 h-8 ${index < 3 ? 'bg-yellow-500' : 'bg-gray-400'} text-white rounded-full flex items-center justify-center text-sm font-bold">
                            ${index + 1}
                        </span>
                        <div>
                            <div class="font-medium text-gray-900 dark:text-white">${goleador.jugador}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">${goleador.equipo}</div>
                        </div>
                    </div>
                    <div class="text-lg font-bold text-gray-900 dark:text-white">${goleador.goles}</div>
                `;
                goleadoresList.appendChild(item);
            });
        }
    }
    
    function updateNoticias() {
        if (ligaMXData.noticias) {
            const noticiasList = document.getElementById('noticias-list');
            noticiasList.innerHTML = '';
            
            ligaMXData.noticias.forEach(noticia => {
                const item = document.createElement('div');
                item.className = 'bg-gray-50 dark:bg-gray-900 rounded-lg p-6 hover:shadow-md transition-shadow';
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h5 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">${noticia.titulo}</h5>
                            <div class="flex items-center space-x-4 text-sm text-gray-500 dark:text-gray-400">
                                <span><i class="fas fa-newspaper mr-1"></i>${noticia.fuente}</span>
                                <span><i class="fas fa-clock mr-1"></i>${PanelL3HO.formatDate(noticia.fecha)}</span>
                            </div>
                        </div>
                        ${noticia.enlace ? `<a href="${noticia.enlace}" target="_blank" class="ml-4 text-blue-600 hover:text-blue-800"><i class="fas fa-external-link-alt"></i></a>` : ''}
                    </div>
                `;
                noticiasList.appendChild(item);
            });
        }
    }
    
    function updateStats() {
        if (ligaMXData.tabla) {
            document.getElementById('total-matches').textContent = 
                ligaMXData.tabla.reduce((sum, team) => sum + (team.partidos_jugados || 0), 0);
            
            document.getElementById('goals-scored').textContent = 
                ligaMXData.tabla.reduce((sum, team) => sum + (team.goles_favor || 0), 0);
        }
        
        if (ligaMXData.noticias) {
            document.getElementById('news-count').textContent = ligaMXData.noticias.length;
        }
    }
    
    // Event listeners
    document.getElementById('refresh-data').addEventListener('click', loadLigaMXData);
    
    document.getElementById('export-data').addEventListener('click', function() {
        const dataStr = JSON.stringify(ligaMXData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `liga_mx_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
    });
    
    // Función para auto-refresh
    function refreshData() {
        if (currentTab === 'tabla') {
            loadLigaMXData();
        }
    }
    
    // Cargar datos iniciales
    document.addEventListener('DOMContentLoaded', function() {
        loadLigaMXData();
        console.log('Football module initialized');
    });
</script>
{% endblock %}